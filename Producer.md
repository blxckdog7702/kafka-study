# Producer  

## acks 옵션  

### 메시지 손실 가능성이 높지만 빠른 전송이 필요한 경우  
acks = 0으로 설정하는 경우이다. 메시지를 전송할 때 프로듀서는 카프카 서버에서 응답을 기다리지 않고 메시지를 보낼 준비가 되는 즉시 다음 요청을 보낸다. 모종의 이유로 메시지 전달이 실패했거나, 브로커가 다운되는 경우 메시지는 유실된다. 메시지 손실을 감안하고 매우 빠르게 처리가 필요한 경우에 선택할 수 있는 옵션이다.  

### 메시지 손실 가능성이 적고 적당한 속도의 전송이 필요한 경우  
acks = 1로 설정하는 경우이다. 프로듀서가 카프카에 메시지를 보낸 후, 응답을 받고 나서 다음 메시지를 보내는 것이다. 일반적인 경우에 메시지 손실이 없으나 특별한 상황에 메시지 손실이 발생한다.  
일반적인 경우, 리더는 메시지를 받고나서 응답을 보낸다. 그 후 팔로워들과 동기화를 한다.  
메시지 손실이 발생하는 경우, 똑같이 리더는 메시지를 받고나서 응답을 보낸다. 하지만 팔로워들과 동기화를 하기 전에 장애가 발생하여 리더는 다운된다. 프로듀서 입장에서는 응답을 받았기 때문에 다음 메시지를 보내고, 새로 리더가 된 브로커는 다음 메시지를 받아서 처리를 한다. 기존 리더가 받았던 메시지는 손실된 것이다.  

### 전송 속도는 느리지만 메시지 손실은 없어야하는 경우  
acks = all로 설정하는 경우이다.  
min.insync.replicas = 1로 설정하는 경우, 프로듀서가 보낸 메시지를 리더가 받는다. 그리고 최소 하나의 리플리케이션을 갖췄기 때문에 acks 메시지를 보낸다. acks = all로 설정했지만 동작은 acks = 1 처럼 하게된다. 왜냐하면 min.insync.replicas에 정의된 값이 1이기 때문이다.  
카프카는 프로듀서만 acks = all로 메시지를 보낸다고 해서 손실 없는 메시지를 보장해주는 것이 아니기 때문에 옵션을 잘 이해하고 설정해야 한다.  
min.insync.replicas = 2로 설정하는 경우, 프로듀서가 보낸 메시지를 리더가 받는다. 그 후 팔로워가 하나라도 메시지를 싱크했으면 2개의 리플리케이션이 되었기 때문에 acks를 프로듀서에게 보낸다.  

> 아파치 카프카 문서에서는 손실 없는 메시지 발송 조건으로 acks = all, min.insync.replicas = 2, 토픽의 리플리케이션 팩터는 3으로 권장하고 있다.  
min.insync.replicas = 3인 경우 3대의 브로커 중 1대가 다운되는 경우, 3대의 리플리케이션을 달성할 수 없기 때문에 에러 메시지가 출력된다.  


[출처] : 고승범, 공용준, *카프카, 데이터 플랫폼의 최강자* (책만, 2018)  