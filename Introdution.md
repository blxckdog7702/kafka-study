# 카프카 소개  

오늘날 정보는 실시간으로 끊임없이 생성되고, 처리되며, 소비된다. 대부분의 경우, 정보를 생산하는 어플리케이션과 소비하는 어플리케이션이 분리되어 있다. 정보의 생산자와 소비자를 연동하는 것 만으로도 이 둘을 다시 개발해야하는 경우가 대부분이다. 아파치 카프카를 쓰면 재개발 없이도 정보 연동이 가능해진다.  

카프카는 실시간으로 대량의 정보를 다루고, 정보를 여러 소비자에게 빠르게 전달하기 위한 솔루션이다. 정보 생산자와 소비자는 서로에 대한 정보를 알 필요 없이 각자 정보를 생산, 소비하기만 하면 된다.  

아파치 카프카는 **분산 발행-구독** 메시징 시스템으로 다음 특징들이 있다.  
- 비휘발성 메시징 : 빅데이터에서 가치를 끌어내기 위해 정보 유실을 막는다. O(1) 디스크 구조로 디자인되어서 아무리 많은 양의 저장 메시지라도 상수 시간 성능을 제공한다.
- 높은 처리량 : 일반 상용 하드웨어에서도 초당 수백만 건의 메시지를 처리할 수 있게 디자인 되었다.
- 분산 : 카프카는 명시적으로 카프카 서버들을 대상으로 메시지 파티셔닝을 지원한다. 또한, 소비자 장비들이 속한 클러스터 단위로 분산 소비를 지원하는데 파티션 단위로만 순서를 가진다.
- 다양한 클라이언트 지원 : Java, .NET, PHP, Ruby, Python 등 다양한 플랫폼과 연동 가능하다.
- 실시간 : 생산자 스레드에 의해 생성된 메시지는 즉시 소비자 스레드에서 볼 수 있어야 한다.

## 디자인  

### 분산 시스템  

### 페이지 캐시  
OS는 물리적 메모리에 애플리케이션이 사용하는 부분을 할당하고 남은 잔여 메모리 일부를 페이지 캐시로 유지해 OS의 전체적인 성능 향상을 높이게 된다.  
이렇게 잔여 메모리를 이용해 디스크에 읽고 쓰기를 하지 않고 페이지 캐시를 통해 쓰고 읽는 방식을 이용하면 처리 속도가 매우 빨라져 전체적인 성능 향상이 가능해진다.  
카프카는 이런 특성을 이용해 빠른 액세스를 하기 위해 OS 페이지 캐시를 이용하도록 디자인되었다.  
이 덕분에 카프카를 구성할때 디스크 중에서 가장 저렴한 SATA 디스크를 사용해도 무방하다. 공식 문서에도 카프카를 SATA 디스크로 운영하고 있다고 적혀있다.  

> 카프카는 5GB의 힙 메모리면 충분하고, 남은 메모리는 페이지 캐시로 사용하길 권장한다.  
또한 페이지 캐시를 서로 공유해야 하기 떄문에 하나의 시스템에 카프카를 다른 어플리케이션과 함께 실행하는 것은 권장하지 않는다.  

### 배치 전송 처리  
작은 IO가 빈번하게 일어나면 그만큼의 네트워크 왕복 오버헤드가 발생한다. 그래서 작은 메시지들을 묶어서 한 번에 보내 작업 속도를 향상시킨다.  

### 모든 브로커가 다운된다면  
조건  
1. 카프카 클러스터는 3대의 브로커로 구성
1. 토픽은 리플리케이션 팩터 3 옵션으로 구성
1. 프로듀서가 데이터를 보내는 중 브로커가 1대씩 다운
1. 최종적으로 모든 브로커가 다운

위 상황이 진행되며 각 브로커는 토픽 팔로워2 : [A], 팔로워1 : [A, B], 리더 : [A, B, C]의 메시지를 받고 다운된다.  
여기서 살아나는 방법은 2가지가 있다.
1. 마지막 리더가 살아나기를 기다린다.
1. ISR에서 추방되었지만 먼저 살아나면 자동으로 리더가 된다.  

마지막 리더가 모든 메시지를 갖고 있기 때문에 메시지 손실 없이 장애 상황을 넘길 수 있지만, 리더 브로커가 되살아나지 않으면 카프카 클러스터 전체의 장애가 길어지게 된다.  
다음 방법은 ISR에서 추방되었지만 가장 먼저 살아나는 브로커를 리더로 만드는 방법인데, 메시지 손실이 발생하게 된다.  
토픽 팔로워 2가 먼저 살아나서 새로운 리더가 되었다고 하면, A메시지 다음에 D메시지를 받아 [A, D]가 된다.  
나머지 토픽 팔로워1 과 리더는 살아나보니 새로운 리더가 존재하고 동기화 작업을 시작해 모든 브로커는 [A, D]가 되고 메시지 B, C는 손실된다.  

`unclean.leader.election.enable` 옵션에서 위 두 방법을 설정할 수 있다.  

### 주키퍼 지노드  


[출처] : 고승범, 공용준, *카프카, 데이터 플랫폼의 최강자* (책만, 2018)  